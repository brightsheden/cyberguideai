<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Analyze Link ‚Äî CyberGuide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-[#0a0a0a] text-white">
    <header class="fixed top-0 left-0 right-0 h-16 bg-black/80 backdrop-blur-md border-b border-[#2a2a2a] z-50">
        <div class="max-w-full h-full px-6 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="text-2xl">üõ°Ô∏è</div>
                <h1 class="font-header text-2xl font-bold tracking-tight">CYBERGUIDE</h1>
            </div>
            <div>
                <a href="/" class="text-sm text-[#a3a3a3] hover:text-[#00ff41]">Back</a>
            </div>
        </div>
    </header>

    <main class="pt-20 max-w-3xl mx-auto p-6">
        <div class="bg-[#0f172a] border border-[#2a2a2a] rounded-xl p-6">
            <h2 class="text-lg font-semibold mb-3">üîó Analyze Link</h2>
            <p class="text-sm text-[#a3a3a3] mb-4">Paste a link below to run a passive analysis (no active probing).</p>

            <div class="space-y-3">
                <input id="link_input" type="text" placeholder="https://example.com/path" class="w-full p-3 bg-[#141414] border border-[#2a2a2a] rounded" />
                <div class="flex gap-2">
                    <button id="runLinkBtn" class="px-4 py-2 bg-[#00d9ff] text-black rounded">Analyze</button>
                    <button id="linkClearBtn" class="px-4 py-2 border rounded">Clear</button>
                </div>
                <div id="linkResult" class="mt-4 hidden bg-[#0a0a0a] p-3 rounded text-sm"></div>
            </div>
        </div>
    </main>

    <script>
        async function postLink(url) {
            try {
                const resp = await fetch('/analyze/link/', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                        'X-CSRFToken': (document.cookie.match('(^|;)\\s*' + 'csrftoken' + '\\s*=\\s*([^;]+)') || [])[2]
                    },
                    body: new URLSearchParams({url: url})
                });
                const data = await resp.json();
                return data;
            } catch (e) {
                return {ok:false, error: String(e)};
            }
        }

        document.getElementById('runLinkBtn').addEventListener('click', async () => {
            const url = document.getElementById('link_input').value || '';
            if (!url.trim()) return alert('Enter a URL');
            const out = document.getElementById('linkResult');
            out.classList.remove('hidden');
            out.innerHTML = '<div class="text-sm text-[#a3a3a3]">Analyzing‚Ä¶</div>';
            const res = await postLink(url);
            renderLinkResult(out, res);
        });
        document.getElementById('linkClearBtn').addEventListener('click', () => { document.getElementById('link_input').value=''; document.getElementById('linkResult').classList.add('hidden'); });

        // Prefill from query param 'q' if present
        (function(){
            try {
                const params = new URLSearchParams(window.location.search);
                const q = params.get('q');
                if (q) {
                    const el = document.getElementById('link_input');
                    if (el) el.value = decodeURIComponent(q);
                }
            } catch(e){}
        })();

        function renderLinkResult(container, resp) {
            if (!resp) {
                container.innerHTML = '<div class="text-red-400">No response from server</div>';
                return;
            }
            if (!resp.ok) {
                const err = escapeHtml(resp.error || JSON.stringify(resp));
                container.innerHTML = `<div class="text-red-400">Error: ${err}</div>`;
                return;
            }

            const d = resp.data || {};
            const url = escapeHtml(d.url || '');
            const suspicious = d.suspicious === true;
            const reasons = Array.isArray(d.reasons) ? d.reasons : [];
            const comp = d.components || {};
            const scheme = escapeHtml(comp.scheme || '');
            const host = escapeHtml(comp.host || '');
            const port = comp.port !== undefined && comp.port !== null ? String(comp.port) : '';
            const path = escapeHtml(comp.path || '');
            const query = escapeHtml(comp.query || '');

            let html = '';
            html += `<div class="flex items-center gap-3 mb-3"><div class="text-xl">üîó</div><div><div class="font-semibold">Link analysis</div><div class="text-xs text-[#9ca3af]">Passive heuristics</div></div></div>`;
            html += `<div class="mb-3"><span class="inline-block px-2 py-1 text-xs rounded ${suspicious ? 'bg-red-600 text-white' : 'bg-green-800 text-green-200'}">${suspicious ? 'Suspicious' : 'Likely safe'}</span></div>`;

            if (reasons.length) {
                html += `<div class="mb-3 text-sm text-[#a3a3a3]"><strong>Reasons:</strong><ul class="list-disc ml-5 mt-1">${reasons.map(r => `<li>${escapeHtml(r)}</li>`).join('')}</ul></div>`;
            }

            html += `<div class="p-3 bg-[#071018] border border-[#111827] rounded">
                        <div class="text-sm break-all mb-2"><a href="${url}" target="_blank" rel="noopener noreferrer" class="text-cyan-300 hover:underline">${url}</a></div>
                        <div class="text-xs text-[#9ca3af] grid grid-cols-2 gap-2">
                            <div><strong>Scheme</strong><div>${scheme || '-'}</div></div>
                            <div><strong>Host</strong><div>${host}${port ? ':'+port : ''}</div></div>
                            <div><strong>Path</strong><div>${path || '-'}</div></div>
                            <div><strong>Query</strong><div class="break-all">${query || '-'}</div></div>
                        </div>
                     </div>`;

            container.innerHTML = html;
        }

        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
    </script>
</body>
</html>
